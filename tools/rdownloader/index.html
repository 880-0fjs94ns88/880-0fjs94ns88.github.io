<!DOCTYPE html>
<html>
<head>
  <title>rdownloadr</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
</head>
<body>
  <div id="errorBar" style="background-color: red; color: white; padding: 10px; text-align: center; display: none;">RULE34 HAS BLOCKED THE API KEY THAT IS BEING USED!! TO FIX THIS, YOU CAN: <br>- Wait<br>- Contact @errorrail on discord</div>
  <h1>r34 downloader</h1>
  <label for="tag">enter tag</label>
  <input type="text" id="tag" placeholder="">
  <button onclick="startDownload()">download to zip</button>
  <br>
  <progress id="progress" value="0" max="1"></progress>
  <div id="status">press the button</div>
  <script>
    const API_KEY = '';
    const USER_ID = '5377095';
    const PROXY = 'https://corsproxy.io/?url=';
    const testInvalid = 0; 

    async function testAPI() {
      try {
        const testUrl = `https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&limit=0&api_key=${API_KEY}&user_id=${USER_ID}`;
        const response = await fetch(PROXY + encodeURIComponent(testUrl));
        if (!response.ok) {
          throw new Error('HTTP error');
        }
        const text = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/xml');
        if (doc.documentElement.tagName === 'posts') {
          return true;
        } else {
          return false;
        }
      } catch (err) {
        return false;
      }
    }

    async function init() {
      if (testInvalid === 1) {
        document.getElementById('errorBar').style.display = 'block';
      } else {
        const isValid = await testAPI();
        if (!isValid) {
          document.getElementById('errorBar').style.display = 'block';
        }
      }
    }

    init();

    async function startDownload() {
      const tag = document.getElementById('tag').value.trim();
      if (!tag) {
        alert('Please enter a tag');
        return;
      }
      const safeName = tag.replace(/[\/\\?%*:|"<>]/g, '_');
      const zipName = `${safeName}.zip`;
      const status = document.getElementById('status');
      const progress = document.getElementById('progress');
      status.innerText = 'getting amount';
      let totalPosts = 0;
      try {
        const countUrl = `https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&tags=${encodeURIComponent(tag)}&limit=0&api_key=${API_KEY}&user_id=${USER_ID}`;
        const response = await fetch(PROXY + encodeURIComponent(countUrl));
        const text = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/xml');
        totalPosts = parseInt(doc.documentElement.getAttribute('count'), 10) || 0;
        status.innerText = `Total posts: ${totalPosts}`;
        progress.max = totalPosts;
      } catch (err) {
        status.innerText = `error: ${err.message}.`;
      }
      const zip = new JSZip();
      let pid = 0;
      let downloaded = 0;
      const limit = 1000;
      while (true) {
        const url = `https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&json=1&tags=${encodeURIComponent(tag)}&pid=${pid}&limit=${limit}&api_key=${API_KEY}&user_id=${USER_ID}`;
       
        let posts;
        try {
          const res = await fetch(PROXY + encodeURIComponent(url));
          posts = await res.json();
        } catch (err) {
          status.innerText = `error at pid=${pid}: ${err.message}`;
          await new Promise(r => setTimeout(r, 5000));
          continue;
        }
        if (!posts || posts.length === 0) {
          status.innerText = 'no posts';
          break;
        }
        for (const post of posts) {
          const ext = post.file_url.split('.').pop().split('?')[0];
          const filename = `${post.id}_${post.md5}.${ext}`;
          status.innerText = `downloading ${filename} (${downloaded + 1}/${totalPosts || '?'})`;
          try {
            const response = await fetch(PROXY + encodeURIComponent(post.file_url));
            const blob = await response.blob();
            zip.file(filename, blob);
            downloaded++;
            progress.value = downloaded;
          } catch (err) {
            status.innerText = `failed to download ${filename}: ${err.message}`;
          }
        }
        pid += posts.length;
        await new Promise(r => setTimeout(r, 800));
      }
      status.innerText = 'generating';
      const content = await zip.generateAsync({type: 'blob'});
      saveAs(content, zipName);
      status.innerText = `done now beat your meat`;
    }
  </script>
</body>
</html>



